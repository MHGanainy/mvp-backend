# =============================================================================
# Logstash Pipeline Configuration for MVP Backend
# =============================================================================
# Place this file in: ./logstash/pipeline/mvp-backend.conf
# =============================================================================

input {
  beats {
    port => 5044

    # SSL configuration (if using SSL between Filebeat and Logstash)
    # ssl => true
    # ssl_certificate => "/usr/share/logstash/config/certs/logstash.crt"
    # ssl_key => "/usr/share/logstash/config/certs/logstash.key"
    # ssl_certificate_authorities => ["/usr/share/logstash/config/certs/ca.crt"]
  }
}

filter {
  # Only process mvp-backend logs
  if [app] == "mvp-backend" {

    # Flatten entity context for Kibana filtering
    if [entity] {
      ruby {
        code => '
          entity = event.get("entity")
          if entity.is_a?(Hash)
            entity.each do |key, value|
              event.set("entity_#{key}", value) if value
            end
          end
        '
      }
    }

    # Add user identifier for easy searching
    if [userId] and [userEmail] {
      mutate {
        add_field => { "userIdentifier" => "%{userId}:%{userEmail}" }
      }
    }

    # Map log levels to severity numbers
    if [level] {
      translate {
        field => "level"
        destination => "levelSeverity"
        dictionary => {
          "trace" => "10"
          "debug" => "20"
          "info" => "30"
          "warn" => "40"
          "error" => "50"
          "fatal" => "60"
        }
        fallback => "30"
      }
      mutate {
        convert => { "levelSeverity" => "integer" }
      }
    }

    # Parse @timestamp
    if [@timestamp] {
      date {
        match => ["@timestamp", "ISO8601"]
        target => "@timestamp"
      }
    }

    # Convert numeric fields
    mutate {
      convert => {
        "userId" => "integer"
        "statusCode" => "integer"
        "durationMs" => "integer"
      }
      # Remove unnecessary Filebeat fields
      remove_field => ["agent", "ecs", "input", "log", "host"]
    }
  }
}

output {
  if [app] == "mvp-backend" {
    elasticsearch {
      hosts => ["https://elasticsearch:9200"]

      # Index pattern: api-logs-YYYY.MM.DD
      index => "api-logs-%{+yyyy.MM.dd}"

      # Authentication (uses env vars from docker-compose)
      user => "${ELASTICSEARCH_USERNAME}"
      password => "${ELASTICSEARCH_PASSWORD}"

      # SSL configuration
      ssl_enabled => true
      ssl_certificate_authorities => ["/usr/share/logstash/config/certs/ca.crt"]
    }
  }

  # Debug output (comment out in production)
  # stdout { codec => rubydebug }
}
